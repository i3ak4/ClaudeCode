<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>CrimiTrack Mobile</title>
    
    <!-- Apple PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="CrimiTrack">
    <meta name="format-detection" content="telephone=no">
    <meta name="theme-color" content="#2563eb">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #f3f4f6;
            --text: #1f2937;
            --text-secondary: #6b7280;
            --border: #e5e7eb;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #f9fafb;
            color: var(--text);
            overflow-x: hidden;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header */
        .header {
            background: var(--primary);
            color: white;
            padding: calc(var(--safe-area-top) + 16px) 20px 16px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }
        
        .header-subtitle {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 4px;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            padding-bottom: calc(80px + var(--safe-area-bottom));
        }
        
        /* Card */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 16px;
        }
        
        .card-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text);
        }
        
        /* Form Elements */
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text);
        }
        
        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.2s;
            -webkit-appearance: none;
            background: white;
        }
        
        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 120px;
        }
        
        /* Buttons */
        .btn {
            display: inline-block;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            text-decoration: none;
            -webkit-appearance: none;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-secondary {
            background: var(--secondary);
            color: var(--text);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-block {
            display: block;
            width: 100%;
        }
        
        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid var(--border);
            padding-bottom: var(--safe-area-bottom);
            z-index: 100;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
        }
        
        .nav-items {
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-secondary);
        }
        
        .nav-item:active {
            transform: scale(0.95);
        }
        
        .nav-item.active {
            color: var(--primary);
        }
        
        .nav-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }
        
        .nav-label {
            font-size: 12px;
            font-weight: 500;
        }
        
        /* Sections */
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .quick-action {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .quick-action:active {
            transform: scale(0.98);
            background: var(--secondary);
        }
        
        .quick-action-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }
        
        .quick-action-label {
            font-weight: 500;
            color: var(--text);
        }
        
        /* List Items */
        .list-item {
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .list-item:active {
            background: var(--secondary);
        }
        
        .list-item-header {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .list-item-details {
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: calc(100px + var(--safe-area-bottom));
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--text);
            color: white;
            padding: 12px 24px;
            border-radius: 24px;
            font-size: 14px;
            z-index: 200;
            opacity: 0;
            transition: all 0.3s;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 300;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .modal-close {
            float: right;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-secondary);
            margin-top: -8px;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .empty-state-subtitle {
            font-size: 14px;
        }
        
        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        /* Badge */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .badge-primary {
            background: var(--primary);
            color: white;
        }
        
        .badge-success {
            background: var(--success);
            color: white;
        }
        
        .badge-warning {
            background: var(--warning);
            color: white;
        }
        
        .badge-danger {
            background: var(--danger);
            color: white;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <h1>CrimiTrack Mobile</h1>
            <div class="header-subtitle">Version simplifiée pour iPad</div>
        </header>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Home Section -->
            <section class="section active" id="home">
                <div class="quick-actions">
                    <div class="quick-action" onclick="showNewExpertiseModal()">
                        <div class="quick-action-icon">➕</div>
                        <div class="quick-action-label">Nouvelle Expertise</div>
                    </div>
                    <div class="quick-action" onclick="showImportModal()">
                        <div class="quick-action-icon">📥</div>
                        <div class="quick-action-label">Importer Base</div>
                    </div>
                    <div class="quick-action" onclick="generateQuickReport()">
                        <div class="quick-action-icon">📄</div>
                        <div class="quick-action-label">Compte-rendu</div>
                    </div>
                    <div class="quick-action" onclick="showSection('stats'); updateNavigation('stats')">
                        <div class="quick-action-icon">📊</div>
                        <div class="quick-action-label">Statistiques</div>
                    </div>
                </div>
                
                <div class="card">
                    <h2 class="card-header">Expertises récentes</h2>
                    <div id="recentExpertises">
                        <div class="empty-state">
                            <div class="empty-state-icon">📋</div>
                            <div class="empty-state-title">Aucune expertise</div>
                            <div class="empty-state-subtitle">Commencez par ajouter une nouvelle expertise</div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Expertises Section -->
            <section class="section" id="expertises">
                <div class="card">
                    <h2 class="card-header">Liste des expertises</h2>
                    <button class="btn btn-primary btn-block" onclick="showNewExpertiseModal()">
                        Ajouter une expertise
                    </button>
                    <div id="expertisesList" style="margin-top: 20px;">
                        <div class="empty-state">
                            <div class="empty-state-icon">📁</div>
                            <div class="empty-state-title">Aucune expertise</div>
                            <div class="empty-state-subtitle">Base de données vide</div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Documents Section -->
            <section class="section" id="documents">
                <div class="card">
                    <h2 class="card-header">Générer un document</h2>
                    
                    <div class="form-group">
                        <label class="form-label">Type de document</label>
                        <select class="form-select" id="docType">
                            <option value="">-- Sélectionner --</option>
                            <option value="convocation">Convocation standard</option>
                            <option value="compte-rendu">Compte-rendu d'expertise</option>
                            <option value="attestation">Attestation</option>
                            <option value="facture">Facture</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Expertise concernée</label>
                        <select class="form-select" id="docExpertise">
                            <option value="">-- Sélectionner ou créer --</option>
                            <option value="new">➕ Nouvelle expertise manuelle</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-success btn-block" onclick="generateDocument()">
                        Générer le document
                    </button>
                </div>
                
                <div class="card">
                    <h2 class="card-header">Documents récents</h2>
                    <div id="recentDocuments">
                        <div class="empty-state">
                            <div class="empty-state-icon">📄</div>
                            <div class="empty-state-title">Aucun document</div>
                            <div class="empty-state-subtitle">Les documents générés apparaîtront ici</div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Stats Section -->
            <section class="section" id="stats">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalExpertises">0</div>
                        <div class="stat-label">Expertises totales</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="monthExpertises">0</div>
                        <div class="stat-label">Ce mois-ci</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="pendingExpertises">0</div>
                        <div class="stat-label">En attente</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgDelay">0j</div>
                        <div class="stat-label">Délai moyen</div>
                    </div>
                </div>
                
                <div class="card">
                    <h2 class="card-header">Répartition par type</h2>
                    <div id="typeStats" style="margin-top: 16px;">
                        <div class="empty-state">
                            <div class="empty-state-icon">📊</div>
                            <div class="empty-state-title">Pas de données</div>
                            <div class="empty-state-subtitle">Ajoutez des expertises pour voir les statistiques</div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Settings Section -->
            <section class="section" id="settings">
                <div class="card">
                    <h2 class="card-header">Paramètres</h2>
                    
                    <div class="form-group">
                        <label class="form-label">Nom du praticien</label>
                        <input type="text" class="form-input" id="practitionerName" value="Dr. Gautrelet">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Adresse du cabinet</label>
                        <textarea class="form-textarea" id="practitionerAddress">123 rue Example
75001 Paris</textarea>
                    </div>
                    
                    <button class="btn btn-primary btn-block" onclick="saveSettings()">
                        Enregistrer les paramètres
                    </button>
                </div>
                
                <div class="card">
                    <h2 class="card-header">Données</h2>
                    <button class="btn btn-secondary btn-block" onclick="exportData()">
                        Exporter les données
                    </button>
                    <button class="btn btn-danger btn-block" onclick="clearData()" style="margin-top: 12px;">
                        Effacer toutes les données
                    </button>
                </div>
            </section>
        </main>
        
        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <div class="nav-items">
                <div class="nav-item active" onclick="showSection('home')">
                    <div class="nav-icon">🏠</div>
                    <div class="nav-label">Accueil</div>
                </div>
                <div class="nav-item" onclick="showSection('expertises')">
                    <div class="nav-icon">📋</div>
                    <div class="nav-label">Expertises</div>
                </div>
                <div class="nav-item" onclick="showSection('documents')">
                    <div class="nav-icon">📄</div>
                    <div class="nav-label">Documents</div>
                </div>
                <div class="nav-item" onclick="showSection('stats')">
                    <div class="nav-icon">📊</div>
                    <div class="nav-label">Stats</div>
                </div>
                <div class="nav-item" onclick="showSection('settings')">
                    <div class="nav-icon">⚙️</div>
                    <div class="nav-label">Réglages</div>
                </div>
            </div>
        </nav>
        
        <!-- Toast -->
        <div class="toast" id="toast"></div>
        
        <!-- New Expertise Modal -->
        <div class="modal" id="newExpertiseModal">
            <div class="modal-content">
                <span class="modal-close" onclick="closeModal('newExpertiseModal')">&times;</span>
                <h2 class="modal-header">Nouvelle Expertise</h2>
                
                <div class="form-group">
                    <label class="form-label">Nom du patient</label>
                    <input type="text" class="form-input" id="patientName" placeholder="DUPONT Jean">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Date de naissance</label>
                    <input type="date" class="form-input" id="patientDob">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Date d'expertise</label>
                    <input type="date" class="form-input" id="expertiseDate" value="">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Heure</label>
                    <input type="time" class="form-input" id="expertiseTime" value="09:00">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Magistrat</label>
                    <input type="text" class="form-input" id="magistrat" placeholder="Mme MARTIN">
                </div>
                
                <div class="form-group">
                    <label class="form-label">N° Procédure</label>
                    <input type="text" class="form-input" id="procedure" placeholder="2025/1234">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Type d'expertise</label>
                    <select class="form-select" id="expertiseType">
                        <option value="standard">Standard</option>
                        <option value="urgente">Urgente</option>
                        <option value="victime">Victime</option>
                        <option value="interprete">Avec interprète</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" id="expertiseNotes" placeholder="Notes complémentaires..."></textarea>
                </div>
                
                <button class="btn btn-primary btn-block" onclick="saveExpertise()">
                    Enregistrer l'expertise
                </button>
            </div>
        </div>
        
        <!-- Import Modal -->
        <div class="modal" id="importModal">
            <div class="modal-content">
                <span class="modal-close" onclick="closeModal('importModal')">&times;</span>
                <h2 class="modal-header">Importer une base de données</h2>
                
                <div class="form-group">
                    <label class="form-label">Format JSON uniquement</label>
                    <input type="file" class="form-input" id="importFile" accept=".json">
                </div>
                
                <button class="btn btn-primary btn-block" onclick="importDatabase()">
                    Importer
                </button>
                
                <div style="margin-top: 20px; padding: 16px; background: var(--secondary); border-radius: 8px;">
                    <p style="font-size: 14px; color: var(--text-secondary);">
                        <strong>Note :</strong> L'import remplacera toutes les données existantes. 
                        Assurez-vous d'avoir une sauvegarde avant de continuer.
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // App State
        const appState = {
            currentSection: 'home',
            data: {
                expertises: [],
                documents: [],
                settings: {
                    practitionerName: 'Dr. Gautrelet',
                    practitionerAddress: '123 rue Example\n75001 Paris'
                }
            }
        };
        
        // Initialize
        function init() {
            loadData();
            updateUI();
            setTodayDate();
        }
        
        // Set today's date in forms
        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            const dateInputs = document.querySelectorAll('input[type="date"]');
            dateInputs.forEach(input => {
                if (!input.value) {
                    input.value = today;
                }
            });
        }
        
        // Load data from localStorage
        function loadData() {
            const savedData = localStorage.getItem('crimitrack-mobile-data');
            if (savedData) {
                try {
                    appState.data = JSON.parse(savedData);
                } catch (e) {
                    console.error('Error loading data:', e);
                }
            }
        }
        
        // Save data to localStorage
        function saveData() {
            try {
                localStorage.setItem('crimitrack-mobile-data', JSON.stringify(appState.data));
            } catch (e) {
                console.error('Error saving data:', e);
                showToast('Erreur lors de la sauvegarde');
            }
        }
        
        // Update UI
        function updateUI() {
            updateRecentExpertises();
            updateExpertisesList();
            updateDocumentsList();
            updateStats();
            updateSettings();
            updateDocumentExpertiseSelect();
        }
        
        // Show section
        function showSection(sectionId) {
            // Update sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            
            // Update nav
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            // Find and activate the correct nav item
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                if (item.onclick && item.onclick.toString().includes(sectionId)) {
                    item.classList.add('active');
                }
            });
            
            appState.currentSection = sectionId;
        }
        
        // Show toast
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // Modal functions
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        function showNewExpertiseModal() {
            showModal('newExpertiseModal');
        }
        
        function showImportModal() {
            showModal('importModal');
        }
        
        // Save expertise
        function saveExpertise() {
            const expertise = {
                id: Date.now(),
                patientName: document.getElementById('patientName').value,
                patientDob: document.getElementById('patientDob').value,
                expertiseDate: document.getElementById('expertiseDate').value,
                expertiseTime: document.getElementById('expertiseTime').value,
                magistrat: document.getElementById('magistrat').value,
                procedure: document.getElementById('procedure').value,
                type: document.getElementById('expertiseType').value,
                notes: document.getElementById('expertiseNotes').value,
                createdAt: new Date().toISOString(),
                status: 'pending'
            };
            
            if (!expertise.patientName || !expertise.expertiseDate) {
                showToast('Veuillez remplir les champs obligatoires');
                return;
            }
            
            appState.data.expertises.push(expertise);
            saveData();
            updateUI();
            closeModal('newExpertiseModal');
            showToast('Expertise enregistrée');
            
            // Clear form
            document.getElementById('patientName').value = '';
            document.getElementById('patientDob').value = '';
            document.getElementById('magistrat').value = '';
            document.getElementById('procedure').value = '';
            document.getElementById('expertiseNotes').value = '';
        }
        
        // Update recent expertises
        function updateRecentExpertises() {
            const container = document.getElementById('recentExpertises');
            const recent = appState.data.expertises.slice(-5).reverse();
            
            if (recent.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📋</div>
                        <div class="empty-state-title">Aucune expertise</div>
                        <div class="empty-state-subtitle">Commencez par ajouter une nouvelle expertise</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = recent.map(exp => `
                <div class="list-item" onclick="viewExpertise(${exp.id})">
                    <div class="list-item-header">${exp.patientName}</div>
                    <div class="list-item-details">
                        ${new Date(exp.expertiseDate).toLocaleDateString('fr-FR')} à ${exp.expertiseTime} - 
                        ${exp.magistrat} - ${exp.procedure}
                    </div>
                </div>
            `).join('');
        }
        
        // Update expertises list
        function updateExpertisesList() {
            const container = document.getElementById('expertisesList');
            
            if (appState.data.expertises.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📁</div>
                        <div class="empty-state-title">Aucune expertise</div>
                        <div class="empty-state-subtitle">Base de données vide</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = appState.data.expertises.map(exp => `
                <div class="list-item" onclick="viewExpertise(${exp.id})">
                    <div class="list-item-header">${exp.patientName}</div>
                    <div class="list-item-details">
                        ${new Date(exp.expertiseDate).toLocaleDateString('fr-FR')} - 
                        ${exp.type} - ${exp.status === 'completed' ? '✅ Terminée' : '⏳ En attente'}
                    </div>
                </div>
            `).join('');
        }
        
        // Update document expertise select
        function updateDocumentExpertiseSelect() {
            const select = document.getElementById('docExpertise');
            const options = ['<option value="">-- Sélectionner ou créer --</option>'];
            options.push('<option value="new">➕ Nouvelle expertise manuelle</option>');
            
            appState.data.expertises.forEach(exp => {
                options.push(`<option value="${exp.id}">${exp.patientName} - ${exp.procedure}</option>`);
            });
            
            select.innerHTML = options.join('');
        }
        
        // Generate document
        function generateDocument() {
            const docType = document.getElementById('docType').value;
            const expertiseId = document.getElementById('docExpertise').value;
            
            if (!docType) {
                showToast('Veuillez sélectionner un type de document');
                return;
            }
            
            if (!expertiseId) {
                showToast('Veuillez sélectionner une expertise');
                return;
            }
            
            if (expertiseId === 'new') {
                // Show new expertise modal
                showNewExpertiseModal();
                return;
            }
            
            // Find expertise
            const expertise = appState.data.expertises.find(e => e.id == expertiseId);
            if (!expertise) {
                showToast('Expertise introuvable');
                return;
            }
            
            // Create document
            const doc = {
                id: Date.now(),
                type: docType,
                expertiseId: expertiseId,
                patientName: expertise.patientName,
                createdAt: new Date().toISOString(),
                content: generateDocumentContent(docType, expertise)
            };
            
            appState.data.documents.push(doc);
            saveData();
            updateUI();
            
            // Download document
            downloadDocument(doc);
            showToast('Document généré avec succès');
        }
        
        // Generate document content
        function generateDocumentContent(type, expertise) {
            const date = new Date(expertise.expertiseDate).toLocaleDateString('fr-FR');
            const settings = appState.data.settings;
            
            switch(type) {
                case 'convocation':
                    return `CONVOCATION

${expertise.patientName}

Madame, Monsieur,

Suite à la décision de ${expertise.magistrat} dans le cadre de la procédure n°${expertise.procedure}, vous êtes convoqué(e) pour une expertise psychiatrique.

Date : ${date}
Heure : ${expertise.expertiseTime}
Lieu : ${settings.practitionerAddress}

Veuillez vous munir de votre pièce d'identité et de tout document médical en votre possession.

${settings.practitionerName}`;

                case 'compte-rendu':
                    return `COMPTE-RENDU D'EXPERTISE

Patient : ${expertise.patientName}
Date de naissance : ${expertise.patientDob ? new Date(expertise.patientDob).toLocaleDateString('fr-FR') : 'Non renseignée'}
Date d'expertise : ${date}

Magistrat : ${expertise.magistrat}
Procédure : ${expertise.procedure}

OBSERVATIONS :
${expertise.notes || 'Aucune observation particulière'}

CONCLUSION :
[À compléter]

Fait à Paris, le ${new Date().toLocaleDateString('fr-FR')}
${settings.practitionerName}`;

                case 'attestation':
                    return `ATTESTATION

Je soussigné, ${settings.practitionerName}, atteste avoir examiné ${expertise.patientName} le ${date} dans le cadre de la procédure ${expertise.procedure}.

Fait pour servir et valoir ce que de droit.

Le ${new Date().toLocaleDateString('fr-FR')}
${settings.practitionerName}`;

                case 'facture':
                    const montant = expertise.type === 'urgente' ? 350 : 280;
                    return `FACTURE

${settings.practitionerName}
${settings.practitionerAddress}

Facture N° ${new Date().getFullYear()}-${expertise.id}
Date : ${new Date().toLocaleDateString('fr-FR')}

Patient : ${expertise.patientName}
Procédure : ${expertise.procedure}

Expertise psychiatrique (${expertise.type}) : ${montant}€

Total : ${montant}€`;

                default:
                    return 'Document non défini';
            }
        }
        
        // Download document
        function downloadDocument(doc) {
            const blob = new Blob([doc.content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const date = new Date();
            const dateStr = `${date.getDate().toString().padStart(2, '0')}${(date.getMonth() + 1).toString().padStart(2, '0')}${date.getFullYear().toString().slice(-2)}`;
            a.download = `${doc.patientName.replace(/\s+/g, '_')}_${doc.type}_${dateStr}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Update documents list
        function updateDocumentsList() {
            const container = document.getElementById('recentDocuments');
            const recent = appState.data.documents.slice(-5).reverse();
            
            if (recent.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📄</div>
                        <div class="empty-state-title">Aucun document</div>
                        <div class="empty-state-subtitle">Les documents générés apparaîtront ici</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = recent.map(doc => `
                <div class="list-item" onclick="downloadDocument(${JSON.stringify(doc).replace(/"/g, '&quot;')})">
                    <div class="list-item-header">${doc.type} - ${doc.patientName}</div>
                    <div class="list-item-details">
                        Généré le ${new Date(doc.createdAt).toLocaleDateString('fr-FR')}
                    </div>
                </div>
            `).join('');
        }
        
        // Generate quick report
        function generateQuickReport() {
            showSection('documents');
            updateNavigation('documents');
            document.getElementById('docType').value = 'compte-rendu';
        }
        
        // Update navigation state
        function updateNavigation(sectionId) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.onclick && item.onclick.toString().includes(sectionId)) {
                    item.classList.add('active');
                }
            });
        }
        
        // Update stats
        function updateStats() {
            const expertises = appState.data.expertises;
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            // Total
            document.getElementById('totalExpertises').textContent = expertises.length;
            
            // This month
            const monthExpertises = expertises.filter(e => {
                const date = new Date(e.expertiseDate);
                return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            });
            document.getElementById('monthExpertises').textContent = monthExpertises.length;
            
            // Pending
            const pending = expertises.filter(e => e.status !== 'completed');
            document.getElementById('pendingExpertises').textContent = pending.length;
            
            // Average delay (mock)
            document.getElementById('avgDelay').textContent = '3.2j';
            
            // Type stats
            updateTypeStats();
        }
        
        // Update type stats
        function updateTypeStats() {
            const container = document.getElementById('typeStats');
            const expertises = appState.data.expertises;
            
            if (expertises.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📊</div>
                        <div class="empty-state-title">Pas de données</div>
                        <div class="empty-state-subtitle">Ajoutez des expertises pour voir les statistiques</div>
                    </div>
                `;
                return;
            }
            
            const types = {};
            expertises.forEach(e => {
                types[e.type] = (types[e.type] || 0) + 1;
            });
            
            container.innerHTML = Object.entries(types).map(([type, count]) => `
                <div style="margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                        <span>${type}</span>
                        <span style="font-weight: 600;">${count}</span>
                    </div>
                    <div style="height: 8px; background: var(--secondary); border-radius: 4px; overflow: hidden;">
                        <div style="height: 100%; background: var(--primary); width: ${(count / expertises.length * 100)}%;"></div>
                    </div>
                </div>
            `).join('');
        }
        
        // View expertise
        function viewExpertise(id) {
            const expertise = appState.data.expertises.find(e => e.id === id);
            if (!expertise) return;
            
            showToast(`${expertise.patientName} - ${expertise.procedure}`);
        }
        
        // Update settings
        function updateSettings() {
            document.getElementById('practitionerName').value = appState.data.settings.practitionerName;
            document.getElementById('practitionerAddress').value = appState.data.settings.practitionerAddress;
        }
        
        // Save settings
        function saveSettings() {
            appState.data.settings.practitionerName = document.getElementById('practitionerName').value;
            appState.data.settings.practitionerAddress = document.getElementById('practitionerAddress').value;
            saveData();
            showToast('Paramètres enregistrés');
        }
        
        // Import database
        function importDatabase() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showToast('Veuillez sélectionner un fichier');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Validate data structure
                    if (!data.expertises || !Array.isArray(data.expertises)) {
                        // Try to convert from CrimiTrack format
                        if (data.patients && Array.isArray(data.patients)) {
                            // Convert patients to expertises
                            const expertises = data.patients.map(patient => ({
                                id: Date.now() + Math.random(),
                                patientName: patient.patronyme || `${patient.nom} ${patient.prenom}`,
                                patientDob: patient.dateNaissance || '',
                                expertiseDate: patient.dateExamen || new Date().toISOString().split('T')[0],
                                expertiseTime: patient.heureExamen || '09:00',
                                magistrat: patient.magistrat || '',
                                procedure: patient.numeroInstruction || patient.procedure || '',
                                type: 'standard',
                                notes: patient.notes || '',
                                createdAt: new Date().toISOString(),
                                status: 'pending'
                            }));
                            
                            appState.data.expertises = expertises;
                            saveData();
                            updateUI();
                            closeModal('importModal');
                            showToast(`${expertises.length} expertises importées`);
                            return;
                        }
                        throw new Error('Format de fichier invalide');
                    }
                    
                    // Direct import if correct format
                    appState.data = data;
                    saveData();
                    updateUI();
                    closeModal('importModal');
                    showToast('Base de données importée');
                } catch (error) {
                    console.error('Import error:', error);
                    showToast('Erreur lors de l\'import du fichier');
                }
            };
            reader.readAsText(file);
        }
        
        // Export data
        function exportData() {
            const dataStr = JSON.stringify(appState.data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `crimitrack_export_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('Données exportées');
        }
        
        // Clear data
        function clearData() {
            if (confirm('Êtes-vous sûr de vouloir effacer toutes les données ?')) {
                appState.data = {
                    expertises: [],
                    documents: [],
                    settings: appState.data.settings
                };
                saveData();
                updateUI();
                showToast('Données effacées');
            }
        }
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', init);
        
        // Handle back button
        window.addEventListener('popstate', (e) => {
            e.preventDefault();
        });
        
        // Register service worker for offline capability
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:application/javascript,' + encodeURIComponent(`
                const CACHE_NAME = 'crimitrack-mobile-v1';
                self.addEventListener('install', e => {
                    self.skipWaiting();
                });
                self.addEventListener('activate', e => {
                    clients.claim();
                });
                self.addEventListener('fetch', e => {
                    e.respondWith(fetch(e.request).catch(() => new Response('Offline')));
                });
            `)).catch(err => console.log('SW registration failed'));
        }
    </script>
</body>
</html>